name: Deploy to Sakura Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Cho ph√©p trigger th·ªß c√¥ng

jobs:
  build:
    name: Build Assets
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install Node dependencies
        run: npm ci --legacy-peer-deps

      - name: üèóÔ∏è Build assets
        run: npm run build

      - name: üì§ Upload built assets
        uses: actions/upload-artifact@v4
        with:
          name: built-assets
          path: public/build/
          retention-days: 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: public/build/

      - name: üì¶ Create deployment package and deploy script
        run: |
          mkdir -p deploy
          cp -r app bootstrap config database public resources routes storage artisan composer.json composer.lock .htaccess index.php deploy/
          cd deploy && tar -czf ../deploy.tar.gz .
          cd ..

          # Create deploy script (runs with bash on server)
          cat > deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          cd ~

          # Verify deployment package exists
          if [ ! -f "deploy.tar.gz" ]; then
            echo "‚ùå ERROR: deploy.tar.gz not found! Aborting."
            exit 1
          fi

          # Extract to temp directory
          echo "Extracting files..."
          mkdir -p www/visionboard2026_new
          tar -xzf deploy.tar.gz -C www/visionboard2026_new/
          rm deploy.tar.gz

          # Verify extraction succeeded
          if [ ! -f "www/visionboard2026_new/artisan" ]; then
            echo "‚ùå ERROR: Extraction failed - artisan not found! Aborting."
            rm -rf www/visionboard2026_new
            exit 1
          fi

          # Preserve .env, storage and vendor from current deployment
          CURRENT_DIR=""
          if [ -d "www/visionboard2026" ] && [ -f "www/visionboard2026/artisan" ]; then
            CURRENT_DIR="www/visionboard2026"
          elif [ -f "www/artisan" ]; then
            CURRENT_DIR="www"
          fi

          if [ -n "$CURRENT_DIR" ]; then
            echo "Found current deployment at ~/$CURRENT_DIR"

            if [ -f "$CURRENT_DIR/.env" ]; then
              echo "Preserving .env file..."
              cp "$CURRENT_DIR/.env" www/visionboard2026_new/.env
            fi

            if [ -d "$CURRENT_DIR/storage/app" ]; then
              echo "Preserving storage uploads..."
              rm -rf www/visionboard2026_new/storage/app
              cp -r "$CURRENT_DIR/storage/app" www/visionboard2026_new/storage/app
            fi

            if [ -d "$CURRENT_DIR/vendor" ]; then
              echo "Preserving vendor directory..."
              cp -r "$CURRENT_DIR/vendor" www/visionboard2026_new/vendor
            fi
          else
            echo "‚ö†Ô∏è No current deployment found, deploying fresh"
          fi

          # Backup current deployment if exists
          if [ -d "www/visionboard2026" ]; then
            echo "Backing up current deployment..."
            rm -rf www/visionboard2026_backup
            mv www/visionboard2026 www/visionboard2026_backup
          fi

          # Move new deployment to production
          echo "Activating new deployment..."
          mv www/visionboard2026_new www/visionboard2026

          cd www/visionboard2026

          # Remove .env.production to prevent it from overriding .env
          # Laravel auto-loads .env.{APP_ENV} which causes placeholder values to override real ones
          rm -f .env.production

          # Create storage dirs if missing
          mkdir -p storage/logs storage/framework/cache storage/framework/sessions storage/framework/views

          # Set permissions
          echo "Setting permissions..."
          chmod -R 755 .
          chmod -R 775 storage bootstrap/cache

          # Regenerate autoloader
          echo "Regenerating autoloader..."
          composer dump-autoload --optimize 2>/dev/null || true

          # Run Laravel commands
          echo "Running migrations..."
          php artisan migrate --force

          echo "Setting up storage link..."
          php artisan storage:link 2>/dev/null || true

          echo "Caching configurations..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan cache:clear

          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # Verify config cache has correct APP_KEY
          CACHED_KEY=$(grep "'key'" bootstrap/cache/config.php 2>/dev/null | head -1)
          if echo "$CACHED_KEY" | grep -q "YOUR_APP_KEY_HERE"; then
            echo "‚ùå ERROR: Config cache has placeholder APP_KEY! Check .env file."
            exit 1
          fi

          # Cleanup deploy script
          rm -f ~/deploy.sh

          echo "‚úÖ Deployment completed successfully!"
          SCRIPT

      - name: üì§ Upload files to server
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > deploy_key
          chmod 600 deploy_key
          scp -i deploy_key -P ${{ secrets.SSH_PORT }} -o StrictHostKeyChecking=no \
            deploy.tar.gz deploy.sh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:~/
          rm deploy_key

      - name: ‚öôÔ∏è Run deploy script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: bash ~/deploy.sh

      - name: üîç Health Check
        if: success()
        run: |
          echo "Waiting 5s for server to stabilize..."
          sleep 5
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://visionboard.duonglien.com/login)
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ Health check passed! HTTP $HTTP_STATUS"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $HTTP_STATUS - site may need manual check"
          fi

      - name: ‚úÖ Deployment Status
        if: success()
        run: echo "üéâ Deployment to https://visionboard.duonglien.com/ completed!"
